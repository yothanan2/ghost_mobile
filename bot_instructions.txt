# INSTRUCTIONS FOR VPS AGENT (GHOST BOT V2.01 UPDATE)

The Android App (v2.01) now supports Dynamic Strategy Injection and Visual State Sync.
Please apply the following changes to the Bot's codebase on the VPS.

## 1. Update `mobile_link.py`
**Goal**: Allow the bot to upload its list of recipes to Firebase so the App can display them.

**Action**: Add the `broadcast_recipes` method to the `GhostUplink` class.

```python
    def broadcast_recipes(self, cookbook):
        """
        Uploads the full Recipe Manifest to Firebase for the Mobile App.
        Path: users/{bot_id}/system/recipes
        """
        try:
            self.ref_system = db.reference(f'users/{self.bot_id}/system/recipes')
            self.ref_system.set(cookbook)
            print(f"üìú MANIFEST: Uploaded {len(cookbook)} recipes to Cloud.")
        except Exception as e:
            print(f"‚ö†Ô∏è MANIFEST UPLOAD FAILED: {e}")
```

## 2. Update `dashboard.py`
**Goal**: Sync recipes on startup/change and handle "Remote Save" commands from the App.

**Action A**: Add `sync_recipes` method to `TradingOS` class.
```python
    def sync_recipes(self):
        """Push local cookbook to mobile app."""
        if hasattr(self, 'uplink') and self.uplink and hasattr(self, 'cookbook'):
            self.uplink.broadcast_recipes(self.cookbook)
            print("üì§ Recipes Synced to Mobile.")
```

**Action B**: Call `sync_recipes` in `start_trading_thread` (after history bootstrap).
```python
            # Initial History Sync
            self.executor.bootstrap_mobile_history(limit=30)
            # Initial Recipe Sync
            self.root.after(5000, self.sync_recipes)
```

**Action C**: Update `handle_remote_command` to handle `save_recipe`.
Add this block inside `handle_remote_command` (e.g., after the "Recipe Injection" block):

```python
            # 5. Recipe Save (Remote Editor)
            if "save_recipe" in data:
                try:
                    r_data = data["save_recipe"] # {name: "...", settings: {...}}
                    name = r_data.get("name")
                    settings = r_data.get("settings")
                    
                    if name and settings and hasattr(self, 'cookbook'):
                        # Update Cookbook
                        if name in self.cookbook:
                            self.cookbook[name].update(settings)
                        else:
                            self.cookbook[name] = settings # New Recipe
                        
                        # Persist to Disk
                        import recipes
                        recipes.save_recipes(self.cookbook)
                        
                        # Sync back to cloud (Confirm success)
                        self.sync_recipes()
                        
                        self.mobile_log(f"ÔøΩ REMOTE SAVE: Recipe '{name}' updated.")
                except Exception as e:
                     self.mobile_log(f"‚ùå SAVE ERROR: {e}")
```

## 3. Telemetry Verification
Ensure the `broadcast_vitals` method (in `dashboard.py`) includes these keys (The App expects them now):
- `swarm_mode` (Boolean)
- `use_firewall` (Boolean)
- `whale_tracker` (Boolean, maps to USE_SR_FILTER)
- `auto_rev` (Boolean)
- `risk_percent` (Float)

*End of Instructions*

## 4. [NEW] v2.06 Holiday Logic Sync
**Goal**: Ensure Mobile App detects "PAUSE" state during holidays.

**Action**: Verify `broadcast_vitals` in `dashboard.py`.
Ensure that `mode_name` accurately reflects the "PAUSE" state if the Scheduler or User sets it.

```python
    # In broadcast_vitals()
    # Ensure this logic exists or similar:
    mode_name = self.brain.config.get("MODE_NAME", "MANUAL")
    
    # If Scheduler says PAUSE, override:
    if self.scheduler.is_holiday(): # hypothetical check
         mode_name = "PAUSE"
    
    vitals = {
        "mode_name": mode_name,
        # ... other keys
    }
```
**CRITICAL**: The App looks for the string `"PAUSE"` (case-sensitive) to show the "Resume" UI.

## 5. [NEW] v2.07 Feature Support (Ghost Terminal, Chart, News)
**Goal**: Power the new "Ghost" features with real-time data.

### A. Ghost Terminal (Log Stream)
**Action**: Update `mobile_log` (or `log`) function in `dashboard.py`.
**Logic**: Push the last log message to Firebase, but keep a circular buffer (last 1 msg is fine, App appends history, or replace a list).
**Recommended**: Fire-and-forget push of the *raw text line*.
```python
    # In mobile_log(msg):
    # Payload: {"ts": timestamp, "msg": msg, "type": "INFO/ERROR"}
    self.uplink.ref_logs.push(payload) # Use push() for stream, or limit to last 50 via set()
```
*Note: To save bandwidth, maybe just set a single "latest_log" node and let App listen.*

### B. Ghost Chart (Live Data Packet)
**Action**: In `scan()` loop (inside `execution_engine.py` or where `brain.analyze()` happens).
**Frequency**: Every 1 second (or matching `SCAN_INTERVAL`).
**Condition**: ONLY if `active_trade` is not None.
**Payload**: `users/{bot_id}/live_chart`
```json
{
  "price": 2045.50,
  "candle": {"o":.., "h":.., "l":.., "c":..}, # Current forming candle
  "lines": {
      "entry": 2045.00,
      "sl": 2042.00,
      "tp": 2048.00
  }
}
```

### C. News Radar
**Action**: Update `news_manager.check_news()`.
**Payload**: Inject into `system/vitals`:
```json
"news": {
    "next_event": "CPI (USD)",
    "time_in_minutes": 45,
    "impact": "HIGH"
}
```

*End of Instructions*

## 6. [NEW] v2.08 Security Core (Ghost PIN)
**Goal**: Secure the bot against unauthorized connections (authentication).

**Action A**: Update `config.py`
Add the following variable. The user MUST set this for the app to work.
```python
# SECURITY
GHOST_PIN = "0000" # CHANGE THIS! 4-6 Digit PIN.
```

**Action B**: Update `dashboard.py` (Broadcast Auth Hash)
In `broadcast_vitals` or `on_startup`:
```python
    import hashlib
    
    # 1. Get PIN from Config
    pin = str(self.brain.config.get("GHOST_PIN", "0000"))
    
    # 2. Hash it (SHA256)
    # We do NOT send the raw PIN. We send the Hash.
    # App will Hash the User Input and Compare.
    pin_hash = hashlib.sha256(pin.encode()).hexdigest()
    
    # 3. Upload to Secure Node
    self.uplink.ref.child("system/auth/pin_hash").set(pin_hash)
    print(f"üîê SECURITY: Ghost Key Hashed & Uploaded.")
```
**CRITICAL**: Without this hash at `system/auth/pin_hash`, the v2.08 App will REFUSE to connect.
